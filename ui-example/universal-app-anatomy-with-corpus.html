<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal App Anatomy + Corpus Patterns</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            position: relative;
            max-width: 1920px;
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        #canvas-container {
            position: relative;
            width: 100%;
            background: white;
        }

        .screenshot {
            width: 100%;
            display: block;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .area {
            position: absolute;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
        }

        /* Pattern-based coloring */
        .area[data-patterns*="C1"], .area[data-patterns*="C2"], .area[data-patterns*="C3"], 
        .area[data-patterns*="C4"], .area[data-patterns*="C5"] {
            border-style: solid;
        }

        .area[data-patterns*="P1"], .area[data-patterns*="P2"], .area[data-patterns*="P3"],
        .area[data-patterns*="P4"], .area[data-patterns*="P5"], .area[data-patterns*="P6"] {
            border-style: dashed;
        }

        .area[data-patterns*="F1"], .area[data-patterns*="F2"], .area[data-patterns*="F3"],
        .area[data-patterns*="F4"] {
            border-style: dotted;
        }

        /* Level-based coloring (default) */
        .area.l1-container {
            border-color: rgba(239, 68, 68, 0.8);
            background: rgba(239, 68, 68, 0.08);
            border-width: 3px;
        }

        .area.l1-container:hover,
        .area.l1-container.active {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            z-index: 5;
        }

        .area.l2-region {
            border-color: rgba(59, 130, 246, 0.7);
            background: rgba(59, 130, 246, 0.1);
            border-width: 3px;
        }

        .area.l2-region:hover,
        .area.l2-region.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.18);
            z-index: 6;
        }

        .area.l3-zone {
            border-color: rgba(168, 85, 247, 0.65);
            background: rgba(168, 85, 247, 0.09);
            border-width: 2px;
            border-style: dashed;
        }

        .area.l3-zone:hover,
        .area.l3-zone.active {
            border-color: #a855f7;
            background: rgba(168, 85, 247, 0.16);
            z-index: 7;
        }

        .area.l4-component {
            border-color: rgba(34, 197, 94, 0.6);
            background: rgba(34, 197, 94, 0.07);
            border-width: 2px;
            border-style: dotted;
        }

        .area.l4-component:hover,
        .area.l4-component.active {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.14);
            z-index: 8;
        }

        .area.l5-atom {
            border-color: rgba(249, 115, 22, 0.55);
            background: rgba(249, 115, 22, 0.06);
            border-width: 1px;
            border-style: dotted;
        }

        .area.l5-atom:hover,
        .area.l5-atom.active {
            border-color: #f97316;
            background: rgba(249, 115, 22, 0.12);
            z-index: 9;
        }

        .label {
            position: absolute;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            backdrop-filter: blur(8px);
            max-width: 350px;
        }

        .l1-container .label {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            font-size: 12px;
            font-weight: 700;
        }

        .l2-region .label {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .l3-zone .label {
            background: linear-gradient(135deg, #a855f7, #9333ea);
        }

        .l4-component .label {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .l5-atom .label {
            background: linear-gradient(135deg, #f97316, #ea580c);
            font-size: 10px;
        }

        .area:hover .label,
        .area.active .label {
            opacity: 1;
            transform: translateY(0);
        }

        .label::before {
            content: attr(data-id);
            display: inline-block;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            font-family: 'Courier New', monospace;
            font-size: 9px;
        }

        .label .patterns {
            display: block;
            font-size: 9px;
            margin-top: 4px;
            opacity: 0.9;
            font-family: 'Courier New', monospace;
        }

        .pattern-tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 3px;
            margin-top: 2px;
        }

        .domain-selector {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            max-width: 90vw;
        }

        .domain-selector h4 {
            font-size: 13px;
            color: #1f2937;
            margin-right: 10px;
        }

        .domain-selector button {
            background: #e5e7eb;
            color: #374151;
            border: 2px solid transparent;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .domain-selector button:hover {
            background: #d1d5db;
            transform: translateY(-1px);
        }

        .domain-selector button.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .controls {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 240px;
            max-width: 280px;
            transition: all 0.3s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        .controls.hidden {
            transform: translateX(calc(100% + 40px));
        }

        .controls h4 {
            margin-bottom: 12px;
            font-size: 14px;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .controls button {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .controls button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .controls button.secondary {
            background: #6b7280;
        }

        .controls button.secondary:hover {
            background: #4b5563;
        }

        .controls button.pattern-filter {
            background: #8b5cf6;
            font-size: 11px;
            padding: 8px 12px;
        }

        .controls button.pattern-filter:hover {
            background: #7c3aed;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h5 {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            z-index: 1000;
            max-height: 85vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .legend.hidden {
            transform: translateX(calc(-100% - 40px));
        }

        .legend h3 {
            margin-bottom: 18px;
            font-size: 17px;
            color: #111827;
            font-weight: 700;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .legend-section {
            margin-bottom: 18px;
        }

        .legend-section h4 {
            font-size: 11px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            font-size: 12px;
            color: #374151;
            line-height: 1.5;
        }

        .legend-color {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid;
            flex-shrink: 0;
            position: relative;
        }

        .legend-color::after {
            content: attr(data-level);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .legend-text {
            flex: 1;
        }

        .legend-text strong {
            display: block;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .legend-text small {
            color: #6b7280;
            font-size: 11px;
        }

        .pattern-legend-item {
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            background: #f9fafb;
            font-size: 11px;
        }

        .pattern-legend-item strong {
            color: #1f2937;
            font-weight: 600;
        }

        .pattern-legend-item code {
            background: #e5e7eb;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }

        .domain-note {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
            padding: 12px;
            margin-top: 12px;
            border-radius: 6px;
            font-size: 11px;
            color: #1e40af;
        }

        .hierarchy-note {
            background: #f0fdf4;
            border-left: 3px solid #22c55e;
            padding: 12px;
            margin-top: 12px;
            border-radius: 6px;
            font-size: 11px;
            color: #15803d;
        }

        .legend-instructions {
            margin-top: 18px;
            padding-top: 18px;
            border-top: 2px solid #e5e7eb;
            font-size: 11px;
            color: #6b7280;
            line-height: 1.6;
        }

        .toggle-panels-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 2px solid #3b82f6;
            color: #3b82f6;
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .toggle-panels-btn:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .pattern-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .pattern-modal.active {
            display: flex;
        }

        .pattern-modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .pattern-modal-content h3 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 12px;
        }

        .pattern-modal-content .pattern-code {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #3b82f6;
            font-weight: 600;
        }

        .pattern-details {
            margin-top: 16px;
        }

        .pattern-details p {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #374151;
        }

        .pattern-details strong {
            color: #1f2937;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e5e7eb;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
            transition: all 0.2s;
        }

        .close-modal:hover {
            background: #d1d5db;
            color: #1f2937;
        }

        @media (max-width: 768px) {
            .legend,
            .controls {
                font-size: 11px;
                padding: 15px;
            }

            .domain-selector {
                flex-wrap: wrap;
                max-width: 90vw;
            }
        }
    </style>
</head>
<body>
    <div class="domain-selector">
        <h4>Domain:</h4>
        <button onclick="switchDomain('cms')" class="active" data-domain="cms">CMS Editor</button>
        <button onclick="switchDomain('code')" data-domain="code">Code Editor</button>
        <button onclick="switchDomain('pkm')" data-domain="pkm">PKM/AI Tool</button>
        <button onclick="switchDomain('math')" data-domain="math">Math Proofs</button>
        <button onclick="switchDomain('cad')" data-domain="cad">CAD/Engineering</button>
    </div>

    <button class="toggle-panels-btn" onclick="togglePanels()">Toggle UI (Tab)</button>

    <div class="controls">
        <div class="control-section">
            <h4>Hierarchy Levels</h4>
            <button onclick="toggleAllLabels()">Toggle All Labels</button>
            <button onclick="toggleLevel('l1-container')" class="secondary">L1: Containers</button>
            <button onclick="toggleLevel('l2-region')" class="secondary">L2: Regions</button>
            <button onclick="toggleLevel('l3-zone')" class="secondary">L3: Zones</button>
            <button onclick="toggleLevel('l4-component')" class="secondary">L4: Components</button>
            <button onclick="toggleLevel('l5-atom')" class="secondary">L5: Atoms</button>
        </div>

        <div class="control-section">
            <h5>Pattern Filters</h5>
            <button onclick="filterByPatternType('C')" class="pattern-filter">Concepts (C)</button>
            <button onclick="filterByPatternType('P')" class="pattern-filter">Patterns (P)</button>
            <button onclick="filterByPatternType('F')" class="pattern-filter">Flows (F)</button>
            <button onclick="clearPatternFilter()" class="pattern-filter secondary">Clear Filter</button>
        </div>

        <div class="control-section">
            <h5>Specific Patterns</h5>
            <button onclick="filterByPattern('C1')" class="pattern-filter">C1: Graph</button>
            <button onclick="filterByPattern('P1')" class="pattern-filter">P1: Canvas</button>
            <button onclick="filterByPattern('P3')" class="pattern-filter">P3: Navigator</button>
            <button onclick="filterByPattern('F2.1')" class="pattern-filter">F2.1: Pipeline</button>
        </div>
    </div>

    <div class="legend">
        <h3>Universal Framework + Corpus</h3>
        
        <div class="legend-section">
            <h4>Hierarchy Levels</h4>
            <div class="legend-item">
                <div class="legend-color" data-level="L1" style="background: rgba(239, 68, 68, 0.15); border-color: #ef4444; border-width: 3px;"></div>
                <div class="legend-text">
                    <strong>L1: Containers</strong>
                    <small>Structural foundation & chrome</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="legend-color" data-level="L2" style="background: rgba(59, 130, 246, 0.15); border-color: #3b82f6; border-width: 3px;"></div>
                <div class="legend-text">
                    <strong>L2: Regions</strong>
                    <small>Spatial divisions & panels</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="legend-color" data-level="L3" style="background: rgba(168, 85, 247, 0.15); border-color: #a855f7; border-style: dashed;"></div>
                <div class="legend-text">
                    <strong>L3: Zones</strong>
                    <small>Functional groupings</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="legend-color" data-level="L4" style="background: rgba(34, 197, 94, 0.15); border-color: #22c55e; border-style: dotted;"></div>
                <div class="legend-text">
                    <strong>L4: Components</strong>
                    <small>Reusable blocks</small>
                </div>
            </div>
            <div class="legend-item">
                <div class="legend-color" data-level="L5" style="background: rgba(249, 115, 22, 0.15); border-color: #f97316; border-style: dotted;"></div>
                <div class="legend-text">
                    <strong>L5: Atoms</strong>
                    <small>Actionable elements</small>
                </div>
            </div>
        </div>

        <div class="legend-section">
            <h4>Corpus Pattern Types</h4>
            <div class="pattern-legend-item">
                <strong>C</strong>: <code>Concepts</code> - Foundational data structures (Graph, Document, Symbolic Expression)
            </div>
            <div class="pattern-legend-item">
                <strong>P</strong>: <code>Patterns</code> - Interaction & architectural patterns (Canvas, Navigator, Pipeline)
            </div>
            <div class="pattern-legend-item">
                <strong>F</strong>: <code>Flows</code> - Data & control flows (Capture, Transform, Feedback, Output)
            </div>
        </div>

        <div class="hierarchy-note">
            <strong>Integration:</strong> Each UI element (L1-L5) implements one or more Corpus patterns (C, P, F). Hover over areas to see which patterns they embody. Click patterns in controls to highlight all implementations.
        </div>

        <div class="domain-note" id="domain-specific-note">
            <strong>CMS Editor Context:</strong> Document editing with collaborative tools, version control, and content management workflows.
        </div>

        <div class="legend-instructions">
            <strong>Usage:</strong> Switch domains to see pattern reuse. Use filters to highlight specific patterns across the interface. Press <strong>Tab</strong> to toggle panels. Click areas for pattern details.
        </div>
    </div>

    <div class="pattern-modal" id="pattern-modal">
        <div class="pattern-modal-content">
            <button class="close-modal" onclick="closePatternModal()">×</button>
            <div id="pattern-modal-body"></div>
        </div>
    </div>

    <div class="container" id="canvas-container">
        <!-- SVG will be dynamically generated here -->
    </div>

    <script>
        // Pattern Definitions from Universal Corpus
        const PATTERNS = {
            // Concepts (C)
            'C1': {
                name: 'Graph Structure',
                type: 'Concept',
                definition: 'A set of nodes N and edges E representing relationships',
                properties: '(N, E, λₙ, λₑ) where λ are labeling functions',
                manifestations: 'Knowledge graphs, file trees, feature history, axiom dependencies'
            },
            'C2': {
                name: 'Document/Artifact',
                type: 'Concept',
                definition: 'A structured container D = (content, metadata, version)',
                properties: 'Editable, versionable, searchable, serializable',
                manifestations: 'Text documents, source code, proofs, CAD models'
            },
            'C3': {
                name: 'Symbolic Expression',
                type: 'Concept',
                definition: 'A tree T = (root, children) where nodes are symbols/operators',
                properties: 'Parseable, evaluable, transformable',
                manifestations: 'Mathematical formulas, code AST, constraints, queries'
            },
            'C4': {
                name: 'Metadata Schema',
                type: 'Concept',
                definition: 'A set of key-value pairs with type constraints',
                properties: 'Extensible, indexable, queryable',
                manifestations: 'Tags, properties, attributes, annotations'
            },
            'C5': {
                name: 'Version History',
                type: 'Concept',
                definition: 'A sequence of states and deltas',
                properties: 'Immutable log, reconstructable, branching',
                manifestations: 'Edit history, git commits, feature sequence'
            },
            
            // Patterns (P)
            'P1': {
                name: 'Direct Manipulation Canvas',
                type: 'Pattern',
                definition: 'User interacts directly with visual representation',
                components: 'viewport, objects, cursor, tools',
                flow: 'gesture → interpret → update_visual → persist',
                instances: 'Graph editor, 3D viewport, drawing canvas'
            },
            'P2': {
                name: 'Command Interface',
                type: 'Pattern',
                definition: 'User issues textual commands to system',
                components: 'input_bar, parser, executor, feedback',
                flow: 'command → parse → validate → execute → response',
                instances: 'Search bar, command line, terminal'
            },
            'P3': {
                name: 'Hierarchical Navigator',
                type: 'Pattern',
                definition: 'User traverses tree structure to locate items',
                components: 'tree_view, selection, expansion_state',
                flow: 'click_node → expand → load_children → display',
                instances: 'File explorer, feature tree, theorem library'
            },
            'P4': {
                name: 'Property Inspector',
                type: 'Pattern',
                definition: 'User views/edits attributes of selected object',
                components: 'selection, fields, validators, apply_button',
                flow: 'select_object → load_properties → edit → validate → commit',
                instances: 'Properties panel, inspector, settings'
            },
            'P5': {
                name: 'Tabbed Workspace',
                type: 'Pattern',
                definition: 'Multiple documents/views in switchable tabs',
                components: 'tabs, active_view, buffers',
                flow: 'open_item → create_tab → switch_tab → focus_content',
                instances: 'Editor tabs, document tabs, multi-file editing'
            },
            'P6': {
                name: 'Palette/Toolbar',
                type: 'Pattern',
                definition: 'Collection of tools/actions available for selection',
                components: 'tools, active_tool, cursor_mode',
                flow: 'select_tool → change_mode → apply_to_canvas',
                instances: 'Drawing tools, code actions, sketch tools'
            },
            'P8': {
                name: 'Search-Based Navigation',
                type: 'Pattern',
                definition: 'User finds items via text query',
                components: 'query_input, index, results, ranking',
                flow: 'type_query → search_index → rank → display_results',
                instances: 'File search, theorem search, command palette'
            },
            'P9': {
                name: 'Backlinks/References',
                type: 'Pattern',
                definition: 'Bidirectional navigation between related items',
                components: 'item, references, reverse_index',
                flow: 'view_item → query_references → display_links',
                instances: 'Backlinks panel, references, usages'
            },
            'P10': {
                name: 'Parser/Compiler Pipeline',
                type: 'Pattern',
                definition: 'Multi-stage transformation from source to target',
                components: 'lexer, parser, analyzer, optimizer, generator',
                flow: 'source → lex → tokens → parse → AST → generate → target',
                instances: 'Code compiler, LaTeX renderer, formula parser'
            },
            'P11': {
                name: 'Validator/Checker',
                type: 'Pattern',
                definition: 'Rule-based verification against constraints',
                components: 'rules, input, checker, report',
                flow: 'input → validate → violations → generate_report',
                instances: 'Proof checker, type checker, constraint validator'
            },
            'P16': {
                name: 'Suggestion/Recommendation System',
                type: 'Pattern',
                definition: 'System proactively offers next actions',
                components: 'context, model, candidates, ranking',
                flow: 'context → analyze → candidates → rank → suggestions',
                instances: 'AI suggestions, autocomplete, tactic hints'
            },
            
            // Flows (F)
            'F1.1': {
                name: 'Capture Flow',
                type: 'Flow',
                definition: 'External → Internal data capture',
                components: 'source, validator, normalizer, ingester',
                flow: 'external → capture → validate → normalize → store',
                examples: 'User input, file drop, API call'
            },
            'F2.1': {
                name: 'Pipeline Flow',
                type: 'Flow',
                definition: 'Sequential transformation stages',
                components: 'stages, intermediate_results, error_handling',
                flow: 'input → stage₁ → ir₁ → stage₂ → ... → output',
                examples: 'Source → Compile → Link, Markdown → HTML'
            },
            'F2.2': {
                name: 'Agent Orchestration Flow',
                type: 'Flow',
                definition: 'Coordinator dispatches to specialized agents',
                components: 'orchestrator, agents, task_queue, aggregator',
                flow: 'task → analyze → subtasks → dispatch → collect',
                examples: 'Multi-agent reasoning, parallel tests'
            },
            'F3.2': {
                name: 'Validation Loop',
                type: 'Flow',
                definition: 'Output validated, errors fed back to input',
                components: 'output, validator, error_reporter, corrector',
                flow: 'output → validate → errors → feedback → correction',
                examples: 'Proof verification, compiler errors'
            },
            'F4.1': {
                name: 'Reactive Render Flow',
                type: 'Flow',
                definition: 'UI automatically updates on data change',
                components: 'data, subscribers, render_engine',
                flow: 'Δdata → notify → re-render → display',
                examples: 'Graph visualization, live preview'
            }
        };

        // Domain Configuration with Pattern Annotations
        const DOMAINS = {
            cms: {
                name: "CMS Editor",
                note: "Document editing with collaborative tools, version control, and content management workflows.",
                svgGenerator: generateCMSSVG,
                areas: [
                    { id: "L1.1", level: "l1-container", bounds: { left: 0, top: 0, width: 100, height: 5.8 }, label: "Application Header Container", position: { top: 50, left: 50 }, patterns: [] },
                    { id: "L1.2", level: "l1-container", bounds: { left: 0, top: 5.8, width: 100, height: 3.2 }, label: "Status Bar Container", position: { top: 50, left: 5 }, patterns: ['P26'] },
                    { id: "L1.3", level: "l1-container", bounds: { left: 0, top: 9, width: 100, height: 4.8 }, label: "Document Title Container", position: { top: 50, left: 50 }, patterns: ['C2'] },
                    { id: "L1.4", level: "l1-container", bounds: { left: 0, top: 96.2, width: 100, height: 3.8 }, label: "Status Footer Container", position: { bottom: 100, left: 50 }, patterns: ['P26'] },
                    
                    { id: "L2.1", level: "l2-region", bounds: { left: 0, top: 13.8, width: 17.7, height: 82.4 }, label: "Tool Panel Region", position: { top: 40, left: 50 }, patterns: ['P6'] },
                    { id: "L2.2", level: "l2-region", bounds: { left: 17.7, top: 13.8, width: 59.1, height: 82.4 }, label: "Primary Canvas Region", position: { top: 50, left: 50 }, patterns: ['P1'] },
                    { id: "L2.3", level: "l2-region", bounds: { left: 76.8, top: 13.8, width: 23.2, height: 82.4 }, label: "Inspector Panel Region", position: { top: 40, left: 50 }, patterns: ['P4'] },
                    
                    { id: "L3.1", level: "l3-zone", bounds: { left: 0, top: 13.8, width: 2.2, height: 82.4 }, label: "Tool Selector Zone", position: { top: 50, left: 100 }, patterns: ['P6'] },
                    { id: "L3.2", level: "l3-zone", bounds: { left: 2.2, top: 13.8, width: 15.5, height: 82.4 }, label: "Active Tool Panel", position: { top: 50, left: 50 }, patterns: ['P4', 'C4'] },
                    { id: "L3.3", level: "l3-zone", bounds: { left: 18.5, top: 15.3, width: 57.5, height: 4.2 }, label: "Document Tabs Zone", position: { top: 50, left: 50 }, patterns: ['P5'] },
                    { id: "L3.4", level: "l3-zone", bounds: { left: 23, top: 23.1, width: 51.3, height: 69.4 }, label: "Editor Canvas Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'C2', 'F1.1', 'F4.1'] },
                    { id: "L3.5", level: "l3-zone", bounds: { left: 77.6, top: 15.3, width: 21.6, height: 74.6 }, label: "Properties Inspector Zone", position: { top: 50, left: 50 }, patterns: ['P4', 'C4'] },
                    
                    { id: "L4.1", level: "l4-component", bounds: { left: 2.7, top: 15.3, width: 14.5, height: 3.7 }, label: "Panel Header", position: { top: 100, left: 0 }, patterns: [] },
                    { id: "L4.2", level: "l4-component", bounds: { left: 19.3, top: 16.2, width: 8.3, height: 2.6 }, label: "Active Tab", position: { top: 100, left: 0 }, patterns: ['P5'] },
                    { id: "L4.3", level: "l4-component", bounds: { left: 25.3, top: 26.4, width: 46.6, height: 15.3 }, label: "Content Block", position: { top: 50, left: 100 }, patterns: ['C2', 'C3'] },
                    
                    { id: "L5.1", level: "l5-atom", bounds: { left: 0.4, top: 15.3, width: 1.4, height: 2.4 }, label: "Tool Icon", position: { top: 50, left: 100 }, patterns: [] },
                    { id: "L5.2", level: "l5-atom", bounds: { left: 50.8, top: 10.2, width: 3.2, height: 2.6 }, label: "Save Button", position: { top: 100, left: 50 }, patterns: ['F1.1'] },
                    { id: "L5.3", level: "l5-atom", bounds: { left: 34.1, top: 68.5, width: 6.3, height: 3.3 }, label: "Add Block Button", position: { bottom: 100, left: 50 }, patterns: ['F1.1'] },
                ]
            },
            
            code: {
                name: "Code Editor (IDE)",
                note: "Software development with debugging, version control, terminal access, and code intelligence.",
                svgGenerator: generateCodeEditorSVG,
                areas: [
                    { id: "L1.1", level: "l1-container", bounds: { left: 0, top: 0, width: 100, height: 4.5 }, label: "Menu Bar Container", position: { top: 50, left: 50 }, patterns: [] },
                    { id: "L1.2", level: "l1-container", bounds: { left: 0, top: 4.5, width: 100, height: 4 }, label: "Toolbar Container", position: { top: 50, left: 50 }, patterns: ['P6'] },
                    { id: "L1.3", level: "l1-container", bounds: { left: 0, top: 92.5, width: 100, height: 7.5 }, label: "Terminal Container", position: { bottom: 100, left: 50 }, patterns: ['P2', 'F2.1'] },
                    
                    { id: "L2.1", level: "l2-region", bounds: { left: 0, top: 8.5, width: 4, height: 84 }, label: "Activity Bar Region", position: { top: 40, left: 100 }, patterns: ['P6'] },
                    { id: "L2.2", level: "l2-region", bounds: { left: 4, top: 8.5, width: 16, height: 84 }, label: "Sidebar Region", position: { top: 40, left: 50 }, patterns: ['P3'] },
                    { id: "L2.3", level: "l2-region", bounds: { left: 20, top: 8.5, width: 60, height: 84 }, label: "Editor Region", position: { top: 50, left: 50 }, patterns: ['P1', 'C2', 'C3'] },
                    { id: "L2.4", level: "l2-region", bounds: { left: 80, top: 8.5, width: 20, height: 84 }, label: "Auxiliary Panel Region", position: { top: 40, left: 50 }, patterns: ['P4', 'P11'] },
                    
                    { id: "L3.1", level: "l3-zone", bounds: { left: 4.5, top: 9, width: 15, height: 5 }, label: "Explorer Header Zone", position: { top: 50, left: 50 }, patterns: ['P8'] },
                    { id: "L3.2", level: "l3-zone", bounds: { left: 4.5, top: 14, width: 15, height: 78 }, label: "File Tree Zone", position: { top: 50, left: 50 }, patterns: ['P3', 'C1'] },
                    { id: "L3.3", level: "l3-zone", bounds: { left: 20.5, top: 9, width: 59, height: 4 }, label: "Editor Tabs Zone", position: { top: 50, left: 50 }, patterns: ['P5'] },
                    { id: "L3.4", level: "l3-zone", bounds: { left: 20.5, top: 13, width: 59, height: 79 }, label: "Code Canvas Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'C3', 'F1.1', 'F4.1'] },
                    { id: "L3.5", level: "l3-zone", bounds: { left: 80.5, top: 9, width: 19, height: 25 }, label: "Debugger Zone", position: { top: 20, left: 50 }, patterns: ['P4', 'F3.2'] },
                    { id: "L3.6", level: "l3-zone", bounds: { left: 80.5, top: 34, width: 19, height: 25 }, label: "Outline Zone", position: { top: 50, left: 50 }, patterns: ['C1', 'C3'] },
                    { id: "L3.7", level: "l3-zone", bounds: { left: 0.5, top: 93, width: 99, height: 6.5 }, label: "Terminal Workspace Zone", position: { top: 50, left: 50 }, patterns: ['P2', 'F2.1'] },
                    
                    { id: "L4.1", level: "l4-component", bounds: { left: 5, top: 15, width: 14, height: 2.5 }, label: "Folder Tree Item", position: { top: 100, left: 0 }, patterns: ['C1'] },
                    { id: "L4.2", level: "l4-component", bounds: { left: 21, top: 9.5, width: 12, height: 3 }, label: "Editor Tab", position: { top: 100, left: 50 }, patterns: ['P5'] },
                    { id: "L4.3", level: "l4-component", bounds: { left: 22, top: 18, width: 56, height: 4 }, label: "Line of Code", position: { top: 50, left: 0 }, patterns: ['C3'] },
                    { id: "L4.4", level: "l4-component", bounds: { left: 81, top: 35, width: 18, height: 3 }, label: "Symbol List Item", position: { top: 50, left: 50 }, patterns: ['C3'] },
                    
                    { id: "L5.1", level: "l5-atom", bounds: { left: 0.5, top: 9, width: 3, height: 4 }, label: "Activity Icon", position: { top: 50, left: 100 }, patterns: [] },
                    { id: "L5.2", level: "l5-atom", bounds: { left: 17, top: 9.5, width: 2, height: 3 }, label: "Collapse Button", position: { top: 50, left: 100 }, patterns: [] },
                    { id: "L5.3", level: "l5-atom", bounds: { left: 20.8, top: 14, width: 1.5, height: 2.5 }, label: "Line Number", position: { top: 50, left: 0 }, patterns: [] },
                    { id: "L5.4", level: "l5-atom", bounds: { left: 75, top: 4.8, width: 3, height: 3 }, label: "Run Button", position: { top: 100, left: 50 }, patterns: ['F2.1'] },
                ]
            },
            
            pkm: {
                name: "PKM & AI Reasoning Tool",
                note: "Knowledge management with graph visualization, AI reasoning chains, and semantic connections.",
                svgGenerator: generatePKMSVG,
                areas: [
                    { id: "L1.1", level: "l1-container", bounds: { left: 0, top: 0, width: 100, height: 5 }, label: "Command Bar Container", position: { top: 50, left: 50 }, patterns: ['P2', 'P8'] },
                    { id: "L1.2", level: "l1-container", bounds: { left: 0, top: 5, width: 100, height: 3.5 }, label: "Breadcrumb Container", position: { top: 50, left: 50 }, patterns: ['P7'] },
                    { id: "L1.3", level: "l1-container", bounds: { left: 0, top: 95, width: 100, height: 5 }, label: "Inference Status Container", position: { bottom: 100, left: 50 }, patterns: ['P26', 'F2.2'] },
                    
                    { id: "L2.1", level: "l2-region", bounds: { left: 0, top: 8.5, width: 25, height: 86.5 }, label: "Graph Navigator Region", position: { top: 40, left: 50 }, patterns: ['P1', 'C1'] },
                    { id: "L2.2", level: "l2-region", bounds: { left: 25, top: 8.5, width: 50, height: 86.5 }, label: "Main Workspace Region", position: { top: 50, left: 50 }, patterns: ['P1', 'C2'] },
                    { id: "L2.3", level: "l2-region", bounds: { left: 75, top: 8.5, width: 25, height: 86.5 }, label: "AI Reasoning Region", position: { top: 40, left: 50 }, patterns: ['P16', 'F2.2'] },
                    
                    { id: "L3.1", level: "l3-zone", bounds: { left: 0.5, top: 9, width: 24, height: 40 }, label: "Knowledge Graph Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'C1', 'F4.1'] },
                    { id: "L3.2", level: "l3-zone", bounds: { left: 0.5, top: 49, width: 24, height: 46 }, label: "Backlinks Zone", position: { top: 50, left: 50 }, patterns: ['P9', 'C1'] },
                    { id: "L3.3", level: "l3-zone", bounds: { left: 25.5, top: 9, width: 49, height: 5 }, label: "Note Metadata Zone", position: { top: 50, left: 50 }, patterns: ['C4'] },
                    { id: "L3.4", level: "l3-zone", bounds: { left: 25.5, top: 14, width: 49, height: 81 }, label: "Content Editor Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'C2', 'F1.1'] },
                    { id: "L3.5", level: "l3-zone", bounds: { left: 75.5, top: 9, width: 24, height: 45 }, label: "Reasoning Chain Zone", position: { top: 50, left: 50 }, patterns: ['P15', 'F2.2'] },
                    { id: "L3.6", level: "l3-zone", bounds: { left: 75.5, top: 54, width: 24, height: 41 }, label: "Suggestions Zone", position: { top: 50, left: 50 }, patterns: ['P16'] },
                    
                    { id: "L4.1", level: "l4-component", bounds: { left: 1, top: 10, width: 23, height: 38 }, label: "Graph Visualization", position: { top: 50, left: 50 }, patterns: ['P1', 'C1'] },
                    { id: "L4.2", level: "l4-component", bounds: { left: 1.5, top: 50, width: 23, height: 4 }, label: "Backlink Item", position: { top: 50, left: 50 }, patterns: ['P9'] },
                    { id: "L4.3", level: "l4-component", bounds: { left: 26, top: 20, width: 48, height: 6 }, label: "Content Block", position: { top: 50, left: 50 }, patterns: ['C2'] },
                    { id: "L4.4", level: "l4-component", bounds: { left: 76, top: 10, width: 23, height: 10 }, label: "Reasoning Step Card", position: { top: 50, left: 50 }, patterns: ['P15', 'F2.2'] },
                    { id: "L4.5", level: "l4-component", bounds: { left: 76, top: 55, width: 23, height: 7 }, label: "AI Suggestion Card", position: { top: 50, left: 50 }, patterns: ['P16'] },
                    
                    { id: "L5.1", level: "l5-atom", bounds: { left: 8, top: 25, width: 3, height: 3 }, label: "Graph Node", position: { top: 50, left: 50 }, patterns: ['C1'] },
                    { id: "L5.2", level: "l5-atom", bounds: { left: 1, top: 0.5, width: 8, height: 4 }, label: "AI Chat Toggle", position: { top: 100, left: 50 }, patterns: ['P16'] },
                    { id: "L5.3", level: "l5-atom", bounds: { left: 27, top: 9.5, width: 2, height: 3.5 }, label: "Tag Badge", position: { top: 50, left: 50 }, patterns: ['C4'] },
                    { id: "L5.4", level: "l5-atom", bounds: { left: 95, top: 56, width: 3.5, height: 2.5 }, label: "Apply Suggestion", position: { top: 50, left: 50 }, patterns: ['F1.1'] },
                ]
            },
            
            math: {
                name: "Mathematical Proof Editor",
                note: "Formal mathematics with theorem proving, symbolic computation, and verification systems.",
                svgGenerator: generateMathProofSVG,
                areas: [
                    { id: "L1.1", level: "l1-container", bounds: { left: 0, top: 0, width: 100, height: 6 }, label: "Proof Header Container", position: { top: 50, left: 50 }, patterns: [] },
                    { id: "L1.2", level: "l1-container", bounds: { left: 0, top: 94, width: 100, height: 6 }, label: "Verification Status Container", position: { bottom: 100, left: 50 }, patterns: ['P26', 'P11'] },
                    
                    { id: "L2.1", level: "l2-region", bounds: { left: 0, top: 6, width: 20, height: 88 }, label: "Theorem Library Region", position: { top: 40, left: 50 }, patterns: ['P3', 'P8'] },
                    { id: "L2.2", level: "l2-region", bounds: { left: 20, top: 6, width: 55, height: 88 }, label: "Proof Canvas Region", position: { top: 50, left: 50 }, patterns: ['P1', 'C3'] },
                    { id: "L2.3", level: "l2-region", bounds: { left: 75, top: 6, width: 25, height: 88 }, label: "Verification Panel Region", position: { top: 40, left: 50 }, patterns: ['P11', 'P16'] },
                    
                    { id: "L3.1", level: "l3-zone", bounds: { left: 0.5, top: 7, width: 19, height: 6 }, label: "Library Search Zone", position: { top: 50, left: 50 }, patterns: ['P8'] },
                    { id: "L3.2", level: "l3-zone", bounds: { left: 0.5, top: 13, width: 19, height: 81 }, label: "Axiom List Zone", position: { top: 50, left: 50 }, patterns: ['P3', 'C1'] },
                    { id: "L3.3", level: "l3-zone", bounds: { left: 20.5, top: 7, width: 54, height: 8 }, label: "Theorem Statement Zone", position: { top: 50, left: 50 }, patterns: ['C3'] },
                    { id: "L3.4", level: "l3-zone", bounds: { left: 20.5, top: 15, width: 54, height: 79 }, label: "Proof Steps Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'F2.1', 'C3'] },
                    { id: "L3.5", level: "l3-zone", bounds: { left: 75.5, top: 7, width: 24, height: 30 }, label: "Symbolic Evaluator Zone", position: { top: 50, left: 50 }, patterns: ['P10', 'C3'] },
                    { id: "L3.6", level: "l3-zone", bounds: { left: 75.5, top: 37, width: 24, height: 30 }, label: "Type Checker Zone", position: { top: 50, left: 50 }, patterns: ['P11', 'F3.2'] },
                    { id: "L3.7", level: "l3-zone", bounds: { left: 75.5, top: 67, width: 24, height: 27 }, label: "Proof Assistant Zone", position: { top: 50, left: 50 }, patterns: ['P16', 'F2.2'] },
                    
                    { id: "L4.1", level: "l4-component", bounds: { left: 1, top: 14, width: 18, height: 4 }, label: "Theorem Item", position: { top: 50, left: 50 }, patterns: ['C3'] },
                    { id: "L4.2", level: "l4-component", bounds: { left: 21, top: 8, width: 53, height: 6 }, label: "Theorem Statement", position: { top: 50, left: 50 }, patterns: ['C3'] },
                    { id: "L4.3", level: "l4-component", bounds: { left: 21, top: 20, width: 53, height: 8 }, label: "Proof Step Block", position: { top: 50, left: 50 }, patterns: ['C3', 'F2.1'] },
                    { id: "L4.4", level: "l4-component", bounds: { left: 76, top: 38, width: 23, height: 6 }, label: "Type Constraint Display", position: { top: 50, left: 50 }, patterns: ['P11'] },
                    { id: "L4.5", level: "l4-component", bounds: { left: 76, top: 68, width: 23, height: 5 }, label: "Tactic Suggestion", position: { top: 50, left: 50 }, patterns: ['P16'] },
                    
                    { id: "L5.1", level: "l5-atom", bounds: { left: 17, top: 15, width: 1.5, height: 2 }, label: "Insert Axiom", position: { top: 50, left: 100 }, patterns: [] },
                    { id: "L5.2", level: "l5-atom", bounds: { left: 22, top: 22, width: 4, height: 3 }, label: "Math Symbol", position: { top: 50, left: 50 }, patterns: ['C3'] },
                    { id: "L5.3", level: "l5-atom", bounds: { left: 70, top: 22, width: 3, height: 2.5 }, label: "QED Marker", position: { top: 50, left: 0 }, patterns: [] },
                    { id: "L5.4", level: "l5-atom", bounds: { left: 95, top: 70, width: 3.5, height: 2 }, label: "Apply Tactic", position: { top: 50, left: 50 }, patterns: ['F1.1'] },
                    { id: "L5.5", level: "l5-atom", bounds: { left: 76, top: 2, width: 4, height: 3 }, label: "Verify Button", position: { top: 100, left: 50 }, patterns: ['P11', 'F3.2'] },
                ]
            },
            
            cad: {
                name: "CAD/Engineering Tool",
                note: "Computer-aided design with parametric modeling, simulation, and manufacturing workflows.",
                svgGenerator: generateCADSVG,
                areas: [
                    { id: "L1.1", level: "l1-container", bounds: { left: 0, top: 0, width: 100, height: 5 }, label: "Ribbon Toolbar Container", position: { top: 50, left: 50 }, patterns: ['P6'] },
                    { id: "L1.2", level: "l1-container", bounds: { left: 0, top: 5, width: 100, height: 3 }, label: "Model Browser Container", position: { top: 50, left: 50 }, patterns: ['P7'] },
                    { id: "L1.3", level: "l1-container", bounds: { left: 0, top: 92, width: 100, height: 8 }, label: "Command Line Container", position: { bottom: 100, left: 50 }, patterns: ['P2'] },
                    
                    { id: "L2.1", level: "l2-region", bounds: { left: 0, top: 8, width: 18, height: 84 }, label: "Feature Tree Region", position: { top: 40, left: 50 }, patterns: ['P3', 'C1', 'C5'] },
                    { id: "L2.2", level: "l2-region", bounds: { left: 18, top: 8, width: 62, height: 84 }, label: "3D Viewport Region", position: { top: 50, left: 50 }, patterns: ['P1', 'C2'] },
                    { id: "L2.3", level: "l2-region", bounds: { left: 80, top: 8, width: 20, height: 84 }, label: "Properties Panel Region", position: { top: 40, left: 50 }, patterns: ['P4', 'P11'] },
                    
                    { id: "L3.1", level: "l3-zone", bounds: { left: 0.5, top: 8.5, width: 17, height: 6 }, label: "Part Navigator Zone", position: { top: 50, left: 50 }, patterns: ['P3'] },
                    { id: "L3.2", level: "l3-zone", bounds: { left: 0.5, top: 14.5, width: 17, height: 77.5 }, label: "Feature History Zone", position: { top: 50, left: 50 }, patterns: ['C1', 'C5', 'F2.1'] },
                    { id: "L3.3", level: "l3-zone", bounds: { left: 18.5, top: 8.5, width: 5, height: 83 }, label: "Tools Palette Zone", position: { top: 50, left: 100 }, patterns: ['P6'] },
                    { id: "L3.4", level: "l3-zone", bounds: { left: 23.5, top: 8.5, width: 56, height: 83 }, label: "3D Canvas Zone", position: { top: 50, left: 50 }, patterns: ['P1', 'F4.1'] },
                    { id: "L3.5", level: "l3-zone", bounds: { left: 80.5, top: 8.5, width: 19, height: 25 }, label: "Sketch Parameters Zone", position: { top: 50, left: 50 }, patterns: ['P4', 'C4'] },
                    { id: "L3.6", level: "l3-zone", bounds: { left: 80.5, top: 33.5, width: 19, height: 25 }, label: "Material Properties Zone", position: { top: 50, left: 50 }, patterns: ['P4', 'C4'] },
                    { id: "L3.7", level: "l3-zone", bounds: { left: 80.5, top: 58.5, width: 19, height: 33.5 }, label: "Constraints Zone", position: { top: 50, left: 50 }, patterns: ['P11', 'F3.2'] },
                    
                    { id: "L4.1", level: "l4-component", bounds: { left: 1, top: 15.5, width: 16, height: 3 }, label: "Feature Item", position: { top: 50, left: 50 }, patterns: ['C1', 'C5'] },
                    { id: "L4.2", level: "l4-component", bounds: { left: 24, top: 9, width: 55, height: 82 }, label: "3D Viewport Canvas", position: { top: 50, left: 50 }, patterns: ['P1', 'C2'] },
                    { id: "L4.3", level: "l4-component", bounds: { left: 81, top: 10, width: 18, height: 4 }, label: "Dimension Input", position: { top: 50, left: 50 }, patterns: ['C4'] },
                    { id: "L4.4", level: "l4-component", bounds: { left: 81, top: 35, width: 18, height: 6 }, label: "Material Selector", position: { top: 50, left: 50 }, patterns: ['C4'] },
                    { id: "L4.5", level: "l4-component", bounds: { left: 81, top: 60, width: 18, height: 4 }, label: "Constraint Item", position: { top: 50, left: 50 }, patterns: ['P11'] },
                    
                    { id: "L5.1", level: "l5-atom", bounds: { left: 19, top: 9, width: 3, height: 5 }, label: "Sketch Tool", position: { top: 50, left: 100 }, patterns: ['P6'] },
                    { id: "L5.2", level: "l5-atom", bounds: { left: 19, top: 20, width: 3, height: 5 }, label: "Extrude Tool", position: { top: 50, left: 100 }, patterns: ['P6'] },
                    { id: "L5.3", level: "l5-atom", bounds: { left: 65, top: 85, width: 3, height: 4 }, label: "View Cube", position: { top: 50, left: 50 }, patterns: [] },
                    { id: "L5.4", level: "l5-atom", bounds: { left: 95, top: 12, width: 3, height: 2 }, label: "Lock Icon", position: { top: 50, left: 50 }, patterns: [] },
                    { id: "L5.5", level: "l5-atom", bounds: { left: 15, top: 16.5, width: 1.5, height: 2 }, label: "Visibility Toggle", position: { top: 50, left: 100 }, patterns: [] },
                ]
            }
        };

        let currentDomain = 'cms';
        let allLabelsVisible = false;
        let visibleLevels = new Set();
        let panelsVisible = true;
        let patternFilter = null;

        // SVG Generation Functions (same as before)
        function generateCMSSVG() {
            return `<svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="screenshot">
                <rect width="1920" height="1080" fill="#f3f4f6"/>
                <rect x="0" y="0" width="1920" height="63" fill="#5B9BD5"/>
                <text x="65" y="38" font-family="Arial" font-size="15" font-weight="600" fill="white">CMS Editor</text>
                <rect x="0" y="63" width="1920" height="35" fill="#FFC857"/>
                <text x="25" y="85" font-family="Arial" font-size="12" fill="#333">⚠ AI Status</text>
                <rect x="0" y="98" width="1920" height="52" fill="#e0e7ff"/>
                <text x="55" y="128" font-family="Arial" font-size="14" font-weight="600" fill="#1f2937">Document</text>
                <rect x="0" y="150" width="340" height="890" fill="#f9fafb"/>
                <rect x="0" y="150" width="42" height="890" fill="#ffffff" opacity="0.8"/>
                <rect x="42" y="150" width="298" height="890" fill="#fafafa"/>
                <text x="62" y="189" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">Tools</text>
                <rect x="325" y="150" width="1150" height="890" fill="white"/>
                <rect x="340" y="165" width="1120" height="45" fill="#f3f4f6"/>
                <text x="370" y="194" font-family="Arial" font-size="12" font-weight="600" fill="#3b82f6">📄 Tabs</text>
                <rect x="440" y="250" width="985" height="750" rx="8" fill="white" stroke="#e5e7eb"/>
                <text x="500" y="308" font-family="Arial" font-size="10" fill="#9ca3af">Canvas</text>
                <rect x="1475" y="150" width="445" height="890" fill="#fafafa"/>
                <text x="1505" y="188" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">Inspector</text>
                <rect x="0" y="1040" width="1920" height="40" fill="#f3f4f6"/>
                <text x="25" y="1064" font-family="Arial" font-size="11" fill="#6b7280">Status</text>
            </svg>`;
        }

        function generateCodeEditorSVG() {
            return `<svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="screenshot">
                <rect width="1920" height="1080" fill="#1e1e1e"/>
                <rect x="0" y="0" width="1920" height="48" fill="#2d2d2d"/>
                <text x="20" y="30" font-family="monospace" font-size="13" fill="#cccccc">File Edit View...</text>
                <rect x="0" y="48" width="1920" height="43" fill="#2d2d2d"/>
                <circle cx="900" cy="70" r="12" fill="#4CAF50"/>
                <text x="920" y="76" font-family="Arial" font-size="12" fill="#cccccc">▶ Run</text>
                <rect x="0" y="91" width="77" height="918" fill="#252526"/>
                <rect x="77" y="91" width="307" height="918" fill="#252526"/>
                <text x="95" y="120" font-family="Arial" font-size="13" font-weight="600" fill="#cccccc">EXPLORER</text>
                <text x="95" y="155" font-family="monospace" font-size="12" fill="#8a8a8a">📁 src</text>
                <rect x="384" y="91" width="1152" height="918" fill="#1e1e1e"/>
                <text x="420" y="170" font-family="monospace" font-size="13" fill="#569cd6">def</text>
                <rect x="1536" y="91" width="384" height="918" fill="#252526"/>
                <text x="1556" y="120" font-family="Arial" font-size="13" font-weight="600" fill="#cccccc">DEBUGGER</text>
                <rect x="0" y="999" width="1920" height="81" fill="#1e1e1e" stroke="#2d2d2d" stroke-width="1"/>
                <text x="20" y="1030" font-family="Arial" font-size="12" font-weight="600" fill="#cccccc">TERMINAL</text>
            </svg>`;
        }

        function generatePKMSVG() {
            return `<svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="screenshot">
                <rect width="1920" height="1080" fill="#fafafa"/>
                <rect x="0" y="0" width="1920" height="54" fill="white" stroke="#e5e7eb" stroke-width="1"/>
                <rect x="40" y="15" width="800" height="24" rx="12" fill="#f3f4f6"/>
                <text x="60" y="32" font-family="Arial" font-size="12" fill="#6b7280">Search or ask AI...</text>
                <rect x="0" y="54" width="1920" height="38" fill="#f9fafb"/>
                <text x="30" y="78" font-family="Arial" font-size="11" fill="#6b7280">Home / Knowledge</text>
                <rect x="0" y="92" width="480" height="934" fill="white" stroke="#e5e7eb" stroke-width="1"/>
                <text x="25" y="120" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">Graph</text>
                <circle cx="240" cy="300" r="60" fill="#3b82f6" opacity="0.2" stroke="#3b82f6" stroke-width="2"/>
                <rect x="480" y="92" width="960" height="934" fill="white"/>
                <text x="520" y="138" font-family="Arial" font-size="13" fill="#1e40af">🏷 Tags</text>
                <rect x="1440" y="92" width="480" height="934" fill="white" stroke="#e5e7eb" stroke-width="1"/>
                <text x="1465" y="120" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">AI Reasoning</text>
                <rect x="0" y="1026" width="1920" height="54" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
                <text x="30" y="1058" font-family="Arial" font-size="11" fill="#6b7280">AI: 3 steps</text>
            </svg>`;
        }

        function generateMathProofSVG() {
            return `<svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="screenshot">
                <rect width="1920" height="1080" fill="#fefefe"/>
                <rect x="0" y="0" width="1920" height="65" fill="#6366f1" opacity="0.9"/>
                <text x="40" y="42" font-family="serif" font-size="18" font-weight="600" fill="white">Theorem Prover</text>
                <rect x="0" y="65" width="384" height="950" fill="#f8f9fa"/>
                <text x="25" y="100" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">Library</text>
                <rect x="384" y="65" width="1056" height="950" fill="white"/>
                <text x="440" y="125" font-family="serif" font-size="13" font-weight="600" fill="#92400e">Theorem:</text>
                <text x="420" y="215" font-family="serif" font-size="13" font-weight="600" fill="#1f2937">Proof:</text>
                <rect x="1440" y="65" width="480" height="950" fill="#f8f9fa"/>
                <text x="1465" y="100" font-family="Arial" font-size="13" font-weight="600" fill="#1f2937">Verification</text>
                <rect x="0" y="1015" width="1920" height="65" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
                <text x="40" y="1053" font-family="Arial" font-size="12" font-weight="600" fill="#15803d">✓ Verified</text>
            </svg>`;
        }

        function generateCADSVG() {
            return `<svg viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg" class="screenshot">
                <rect width="1920" height="1080" fill="#2c2c2c"/>
                <rect x="0" y="0" width="1920" height="54" fill="#3d3d3d"/>
                <rect x="20" y="12" width="70" height="30" rx="4" fill="#0078d4"/>
                <text x="32" y="32" font-family="Arial" font-size="11" font-weight="600" fill="white">Sketch</text>
                <rect x="0" y="54" width="1920" height="32" fill="#2c2c2c"/>
                <text x="20" y="76" font-family="Arial" font-size="11" fill="#999999">Part1.ipt</text>
                <rect x="0" y="86" width="346" height="908" fill="#262626"/>
                <text x="20" y="115" font-family="Arial" font-size="12" font-weight="600" fill="#cccccc">Features</text>
                <rect x="346" y="86" width="1190" height="908" fill="#1a1a1a"/>
                <rect x="356" y="96" width="96" height="888" fill="#2c2c2c"/>
                <rect x="452" y="96" width="1074" height="888" fill="#1a1a1a"/>
                <line x1="472" y1="540" x2="1506" y2="540" stroke="#3a3a3a" stroke-width="1"/>
                <line x1="989" y1="116" x2="989" y2="964" stroke="#3a3a3a" stroke-width="1"/>
                <path d="M 700 400 L 1200 400 L 1200 700 L 700 700 Z" fill="none" stroke="#0078d4" stroke-width="3"/>
                <rect x="1536" y="86" width="384" height="908" fill="#262626"/>
                <text x="1556" y="115" font-family="Arial" font-size="12" font-weight="600" fill="#cccccc">Properties</text>
                <rect x="0" y="994" width="1920" height="86" fill="#1a1a1a" stroke="#3d3d3d" stroke-width="1"/>
                <text x="20" y="1025" font-family="Arial" font-size="11" font-weight="600" fill="#cccccc">Command:</text>
            </svg>`;
        }

        // Render the current domain with patterns
        function renderDomain() {
            const domain = DOMAINS[currentDomain];
            const container = document.getElementById('canvas-container');
            
            const svg = domain.svgGenerator();
            
            let areasHTML = domain.areas.map(area => {
                const positionStyle = [];
                if (area.position.top !== undefined) positionStyle.push(`top: ${area.position.top}%`);
                if (area.position.bottom !== undefined) positionStyle.push(`bottom: ${area.position.bottom}%`);
                if (area.position.left !== undefined) positionStyle.push(`left: ${area.position.left}%`);
                if (area.position.right !== undefined) positionStyle.push(`right: ${area.position.right}%`);
                
                const transform = [];
                if (area.position.top !== undefined && area.position.left !== undefined) {
                    transform.push('translate(-50%, -50%)');
                } else if (area.position.bottom !== undefined && area.position.left !== undefined) {
                    transform.push('translateX(-50%)');
                } else if (area.position.top !== undefined && area.position.right !== undefined) {
                    transform.push('translateY(-50%)');
                }
                
                // Apply pattern filter
                if (patternFilter && !matchesPatternFilter(area.patterns, patternFilter)) {
                    return ''; // Skip this area if it doesn't match filter
                }
                
                const patternTags = area.patterns && area.patterns.length > 0
                    ? `<span class="patterns">${area.patterns.map(p => `<span class="pattern-tag">${p}</span>`).join('')}</span>`
                    : '';
                
                return `
                    <div class="area ${area.level}" data-id="${area.id}" data-patterns="${area.patterns ? area.patterns.join(',') : ''}"
                         style="left: ${area.bounds.left}%; top: ${area.bounds.top}%; 
                                width: ${area.bounds.width}%; height: ${area.bounds.height}%;">
                        <div class="label" data-id="${area.id}" 
                             style="${positionStyle.join('; ')}; ${transform.length ? 'transform: ' + transform.join(' ') : ''}">
                            ${area.label}
                            ${patternTags}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                ${svg}
                <div class="overlay">
                    ${areasHTML}
                </div>
            `;
            
            document.getElementById('domain-specific-note').innerHTML = `
                <strong>${domain.name} Context:</strong> ${domain.note}
            `;
            
            attachEventListeners();
        }

        function matchesPatternFilter(patterns, filter) {
            if (!patterns || patterns.length === 0) return false;
            if (filter.length === 1) {
                // Type filter (C, P, or F)
                return patterns.some(p => p.startsWith(filter));
            } else {
                // Specific pattern filter
                return patterns.includes(filter);
            }
        }

        function attachEventListeners() {
            document.querySelectorAll('.area').forEach(area => {
                area.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    
                    // Show pattern modal if patterns exist
                    const patterns = this.dataset.patterns;
                    if (patterns && patterns.length > 0) {
                        showPatternModal(patterns.split(','), this.dataset.id);
                    }
                });
            });
        }

        function showPatternModal(patternCodes, areaId) {
            const modal = document.getElementById('pattern-modal');
            const body = document.getElementById('pattern-modal-body');
            
            let html = `<h3>Area ${areaId} - Patterns</h3>`;
            
            patternCodes.forEach(code => {
                const pattern = PATTERNS[code];
                if (pattern) {
                    html += `
                        <div class="pattern-details">
                            <h4><span class="pattern-code">${code}</span>: ${pattern.name}</h4>
                            <p><strong>Type:</strong> ${pattern.type}</p>
                            <p><strong>Definition:</strong> ${pattern.definition}</p>
                            ${pattern.components ? `<p><strong>Components:</strong> ${pattern.components}</p>` : ''}
                            ${pattern.flow ? `<p><strong>Flow:</strong> ${pattern.flow}</p>` : ''}
                            ${pattern.manifestations ? `<p><strong>Manifestations:</strong> ${pattern.manifestations}</p>` : ''}
                            ${pattern.instances ? `<p><strong>Instances:</strong> ${pattern.instances}</p>` : ''}
                            ${pattern.examples ? `<p><strong>Examples:</strong> ${pattern.examples}</p>` : ''}
                        </div>
                    `;
                }
            });
            
            body.innerHTML = html;
            modal.classList.add('active');
        }

        function closePatternModal() {
            document.getElementById('pattern-modal').classList.remove('active');
        }

        function switchDomain(domainKey) {
            currentDomain = domainKey;
            
            document.querySelectorAll('.domain-selector button').forEach(btn => {
                if (btn.dataset.domain === domainKey) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            allLabelsVisible = false;
            visibleLevels.clear();
            patternFilter = null;
            
            renderDomain();
        }

        function toggleAllLabels() {
            allLabelsVisible = !allLabelsVisible;
            const areas = document.querySelectorAll('.area');
            
            areas.forEach(area => {
                if (allLabelsVisible) {
                    area.classList.add('active');
                } else {
                    area.classList.remove('active');
                }
            });
        }

        function toggleLevel(levelClass) {
            if (visibleLevels.has(levelClass)) {
                visibleLevels.delete(levelClass);
            } else {
                visibleLevels.add(levelClass);
            }

            const areas = document.querySelectorAll('.area');
            areas.forEach(area => {
                if (area.classList.contains(levelClass)) {
                    area.classList.toggle('active');
                }
            });
        }

        function filterByPatternType(type) {
            patternFilter = type;
            renderDomain();
            
            // Highlight all matching areas
            setTimeout(() => {
                document.querySelectorAll('.area').forEach(area => {
                    area.classList.add('active');
                });
            }, 100);
        }

        function filterByPattern(pattern) {
            patternFilter = pattern;
            renderDomain();
            
            setTimeout(() => {
                document.querySelectorAll('.area').forEach(area => {
                    area.classList.add('active');
                });
            }, 100);
        }

        function clearPatternFilter() {
            patternFilter = null;
            renderDomain();
        }

        function togglePanels() {
            panelsVisible = !panelsVisible;
            const legend = document.querySelector('.legend');
            const controls = document.querySelector('.controls');
            
            if (panelsVisible) {
                legend.classList.remove('hidden');
                controls.classList.remove('hidden');
            } else {
                legend.classList.add('hidden');
                controls.classList.add('hidden');
            }
        }

        // Click outside to clear active labels
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.area') && !e.target.closest('.pattern-modal')) {
                if (!allLabelsVisible && visibleLevels.size === 0) {
                    document.querySelectorAll('.area.active').forEach(area => {
                        area.classList.remove('active');
                    });
                }
            }
        });

        // Close modal on click outside
        document.getElementById('pattern-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePatternModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key >= '1' && e.key <= '5') {
                toggleLevel(`l${e.key}-${['container', 'region', 'zone', 'component', 'atom'][e.key - 1]}`);
            }
            if (e.key === 'a' || e.key === 'A') {
                toggleAllLabels();
            }
            if (e.key === 'Tab') {
                e.preventDefault();
                togglePanels();
            }
            if (e.key === 'Escape') {
                closePatternModal();
            }
        });

        // Initial render
        renderDomain();
    </script>
</body>
</html>
