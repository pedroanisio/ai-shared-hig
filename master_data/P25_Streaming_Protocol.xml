<?xml version="1.0" ?>
<pattern xmlns="http://universal-corpus.org/schema/v1" id="P25" version="1.1">
  <metadata>
    <name>Streaming Protocol</name>
    <category>pattern</category>
    <status>stable</status>
    <complexity>medium</complexity>
  </metadata>
  <definition>
    <tuple-notation format="latex">$S = (producer, consumer, buffer, backpressure, state)$</tuple-notation>
    <components>
      <component>
        <name>producer</name>
        <type>Producer</type>
        <notation>producer</notation>
        <description>generates data</description>
      </component>
      <component>
        <name>consumer</name>
        <type>Consumer</type>
        <notation>consumer</notation>
        <description>processes data</description>
      </component>
      <component>
        <name>buffer</name>
        <type>Queue⟨Chunk⟩</type>
        <notation>buffer</notation>
        <description>buffers data</description>
      </component>
      <component>
        <name>backpressure</name>
        <type>Signal</type>
        <notation>backpressure</notation>
        <description>controls flow rate</description>
      </component>
      <component>
        <name>state</name>
        <type>\{\text{flowing}, \text{paused}, \text{ended}, \text{error}\}</type>
        <notation>state</notation>
        <description>stream state</description>
      </component>
    </components>
  </definition>
  <type-definitions>
    <type-def>
      <name>Producer</name>
      <definition format="latex">(generate: () → Chunk | EndOfStream, pause: () → Effect, resume: () → Effect)</definition>
    </type-def>
    <type-def>
      <name>Consumer</name>
      <definition format="latex">(consume: Chunk → Effect)</definition>
    </type-def>
    <type-def>
      <name>Chunk</name>
      <definition format="latex">Sequence⟨Byte⟩ | Value</definition>
    </type-def>
  </type-definitions>
  <properties>
    <property id="P.P25.1">
      <name>Flow Control</name>
      <formal-spec format="latex">buffer full → pause producer → wait → resume producer</formal-spec>
    </property>
    <property id="P.P25.2">
      <name>Chunk Ordering</name>
      <formal-spec format="latex">Chunks consumed in order produced</formal-spec>
    </property>
    <property id="P.P25.3">
      <name>Graceful Termination</name>
      <formal-spec format="latex">Producer sends EndOfStream → consumer processes remaining chunks → close</formal-spec>
    </property>
  </properties>
  <operations>
    <operation>
      <name>Produce</name>
      <signature>produce() → Effect</signature>
      <formal-definition format="latex">```
   produce() → Effect
   = while state = flowing:
       chunk := producer.generate()
       if chunk = EndOfStream:
         state := ended
         consumer.close()
       else:
         buffer := enqueue(buffer, chunk)
         if buffer.size ≥ highWaterMark:
           state := paused
           producer.pause()</formal-definition>
    </operation>
    <operation>
      <name>Consume</name>
      <signature>consume() → Effect</signature>
      <formal-definition format="latex">```
   consume() → Effect
   = while ¬empty(buffer):
       chunk := dequeue(buffer)
       consumer.consume(chunk)
       if buffer.size &lt; lowWaterMark ∧ state = paused:
         state := flowing
         producer.resume()</formal-definition>
    </operation>
    <operation>
      <name>Readable Stream</name>
      <signature/>
      <formal-definition format="latex">```
   Data source (file, network)
   Can only read from</formal-definition>
    </operation>
    <operation>
      <name>Writable Stream</name>
      <signature/>
      <formal-definition format="latex">```
   Data sink (file, response)
   Can only write to</formal-definition>
    </operation>
    <operation>
      <name>Transform Stream</name>
      <signature/>
      <formal-definition format="latex">```
   Readable + Writable
   Transforms data in flight
   Example: compression, encryption</formal-definition>
    </operation>
    <operation>
      <name>Duplex Stream</name>
      <signature/>
      <formal-definition format="latex">```
   Independent readable and writable
   Example: WebSocket</formal-definition>
    </operation>
  </operations>
  <manifestations>
    <manifestation>
      <name>WebSocket</name>
    </manifestation>
    <manifestation>
      <name>Live updates</name>
    </manifestation>
    <manifestation>
      <name>Progressive rendering</name>
    </manifestation>
    <manifestation>
      <name>File uploads/downloads</name>
    </manifestation>
    <manifestation>
      <name>Video streaming</name>
    </manifestation>
  </manifestations>
</pattern>
