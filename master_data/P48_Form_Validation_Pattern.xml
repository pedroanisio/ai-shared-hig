<?xml version="1.0" ?>
<pattern xmlns="http://universal-corpus.org/schema/v1" id="P48" version="1.1">
  <metadata>
    <name>Form Validation Pattern</name>
    <category>pattern</category>
    <status>stable</status>
    <complexity>medium</complexity>
  </metadata>
  <definition>
    <tuple-notation format="latex">$V = (fields, rules, state, errors)$</tuple-notation>
    <components>
      <component>
        <name>fields</name>
        <type>MapâŸ¨String, FieldâŸ©</type>
        <notation>fields</notation>
        <description>form fields</description>
      </component>
      <component>
        <name>rules</name>
        <type>MapâŸ¨String, ValidatorâŸ©</type>
        <notation>rules</notation>
        <description>validation rules</description>
      </component>
      <component>
        <name>state</name>
        <type>MapâŸ¨String, ValidationStateâŸ©</type>
        <notation>state</notation>
        <description>tracks validation status</description>
      </component>
      <component>
        <name>errors</name>
        <type>MapâŸ¨String, SequenceâŸ¨StringâŸ©âŸ©</type>
        <notation>errors</notation>
        <description>stores error messages</description>
      </component>
    </components>
  </definition>
  <type-definitions>
    <type-def>
      <name>Field</name>
      <definition format="latex">(value: Value, dirty: ğ”¹, touched: ğ”¹)</definition>
    </type-def>
    <type-def>
      <name>Validator</name>
      <definition format="latex">Value â†’ ValidationResult</definition>
    </type-def>
    <type-def>
      <name>ValidationResult</name>
      <definition format="latex">Valid | Invalid(errors: SequenceâŸ¨StringâŸ©)</definition>
    </type-def>
    <type-def>
      <name>ValidationState</name>
      <definition format="latex">Pristine | Valid | Invalid | Validating</definition>
    </type-def>
  </type-definitions>
  <properties>
    <property id="P.P48.1">
      <name>Eager Validation</name>
      <formal-spec format="latex">field.dirty âˆ§ field.touched â‡’ validate(field) on change</formal-spec>
    </property>
    <property id="P.P48.2">
      <name>Form-Level Validation</name>
      <formal-spec format="latex">valid(form) â‡” âˆ€f âˆˆ fields: state[f] âˆˆ {Valid, Pristine}</formal-spec>
    </property>
    <property id="P.P48.3">
      <name>Async Validation</name>
      <formal-spec format="latex">validate_async(field) â†’ ValidationResult (eventually)
state[field] = Validating during execution</formal-spec>
    </property>
    <property id="P.P48.4">
      <name>Cross-Field Validation</name>
      <formal-spec format="latex">validate_group([fieldâ‚, fieldâ‚‚, ...]) â†’ ValidationResult
Example: password confirmation</formal-spec>
    </property>
  </properties>
  <operations>
    <operation>
      <name>Validate Field</name>
      <signature>validate(field_name: String) â†’ ValidationResult</signature>
      <formal-definition format="latex">```
   validate(field_name: String) â†’ ValidationResult
   = value := fields[field_name].value
     validator := rules[field_name]
     result := validator(value)
     
     state[field_name] := case result of
       Valid â†’ Valid
       Invalid(errs) â†’ Invalid
     
     errors[field_name] := result.errors
     return result</formal-definition>
    </operation>
    <operation>
      <name>Validate Form</name>
      <signature>validate_form() â†’ ğ”¹</signature>
      <formal-definition format="latex">```
   validate_form() â†’ ğ”¹
   = results := map(keys(fields), validate)
     return all(results, Î»r: r = Valid)</formal-definition>
    </operation>
    <operation>
      <name>Register Rule</name>
      <signature>register_rule(field: String, rule: Validator) â†’ Effect</signature>
      <formal-definition format="latex">```
   register_rule(field: String, rule: Validator) â†’ Effect
   = rules[field] := compose_validators(rules[field], rule)</formal-definition>
    </operation>
    <operation>
      <name>Built-in Validators</name>
      <signature>required(value: Value) â†’ ValidationResult</signature>
      <formal-definition format="latex">```
   required(value: Value) â†’ ValidationResult
   = if value â‰  null âˆ§ value â‰  "":
       Valid
     else:
       Invalid(["This field is required"])
   
   min_length(n: â„•) â†’ Validator
   = Î»value: if length(value) â‰¥ n:
               Valid
             else:
               Invalid([f"Minimum length is {n}"])
   
   email(value: String) â†’ ValidationResult
   = if matches(value, email_regex):
       Valid
     else:
       Invalid(["Invalid email address"])
   
   custom(predicate: Value â†’ ğ”¹, message: String) â†’ Validator
   = Î»value: if predicate(value):
               Valid
             else:
               Invalid([message])</formal-definition>
    </operation>
    <operation>
      <name>On Submit</name>
      <signature/>
      <formal-definition format="latex">```
   Validate all fields when form submitted
   Show all errors at once</formal-definition>
    </operation>
    <operation>
      <name>On Blur</name>
      <signature/>
      <formal-definition format="latex">```
   Validate field when it loses focus
   Show errors immediately</formal-definition>
    </operation>
    <operation>
      <name>On Change</name>
      <signature/>
      <formal-definition format="latex">```
   Validate field on every keystroke
   Show errors after field touched</formal-definition>
    </operation>
    <operation>
      <name>Hybrid (Recommended)</name>
      <signature/>
      <formal-definition format="latex">```
   First error: on blur
   Subsequent: on change (immediate feedback)</formal-definition>
    </operation>
  </operations>
  <manifestations>
    <manifestation>
      <name>Registration forms</name>
    </manifestation>
    <manifestation>
      <name>Login forms</name>
    </manifestation>
    <manifestation>
      <name>Settings panels</name>
    </manifestation>
    <manifestation>
      <name>Data entry forms</name>
    </manifestation>
    <manifestation>
      <name>Survey forms</name>
    </manifestation>
  </manifestations>
</pattern>
