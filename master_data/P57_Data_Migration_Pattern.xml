<?xml version="1.0" ?>
<pattern xmlns="http://universal-corpus.org/schema/v1" id="P57" version="1.1">
  <metadata>
    <name>Data Migration Pattern</name>
    <category>pattern</category>
    <status>stable</status>
    <complexity>medium</complexity>
  </metadata>
  <definition>
    <tuple-notation format="latex">$M = (versions, migrations, current, rollback)$</tuple-notation>
    <components>
      <component>
        <name>versions</name>
        <type>Sequence⟨Version⟩</type>
        <notation>versions</notation>
        <description>schema versions</description>
      </component>
      <component>
        <name>migrations</name>
        <type>Map⟨(Version, Version), Migration⟩</type>
        <notation>migrations</notation>
        <description>define transitions</description>
      </component>
      <component>
        <name>current</name>
        <type>Version</type>
        <notation>current</notation>
        <description>active version</description>
      </component>
      <component>
        <name>rollback</name>
        <type>Migration → Migration</type>
        <notation>rollback</notation>
        <description>reverses migrations</description>
      </component>
    </components>
  </definition>
  <type-definitions>
    <type-def>
      <name>Version</name>
      <definition format="latex">(number: ℕ, schema: Schema)</definition>
    </type-def>
    <type-def>
      <name>Migration</name>
      <definition format="latex">(up: Data → Data, down: Data → Data)</definition>
    </type-def>
    <type-def>
      <name>Schema</name>
      <definition format="latex">description of data structure</definition>
    </type-def>
  </type-definitions>
  <properties>
    <property id="P.P57.1">
      <name>Bidirectionality</name>
      <formal-spec format="latex">∀m ∈ migrations: ∃m⁻¹: m⁻¹(m(data)) = data</formal-spec>
    </property>
    <property id="P.P57.2">
      <name>Transactional</name>
      <formal-spec format="latex">Migration completes fully or rolls back</formal-spec>
    </property>
    <property id="P.P57.3">
      <name>Version Ordering</name>
      <formal-spec format="latex">versions totally ordered: v₁ &lt; v₂ &lt; v₃ &lt; ...</formal-spec>
    </property>
  </properties>
  <operations>
    <operation>
      <name>Migrate Up</name>
      <signature>migrate_up(target: Version) → Effect</signature>
      <formal-definition format="latex">```
   migrate_up(target: Version) → Effect
   = while current &lt; target:
       migration := migrations[(current, next(current))]
       data := migration.up(data)
       current := next(current)</formal-definition>
    </operation>
    <operation>
      <name>Migrate Down</name>
      <signature>migrate_down(target: Version) → Effect</signature>
      <formal-definition format="latex">```
   migrate_down(target: Version) → Effect
   = while current &gt; target:
       migration := migrations[(prev(current), current)]
       data := migration.down(data)
       current := prev(current)</formal-definition>
    </operation>
    <operation>
      <name>Create Migration</name>
      <signature>create_migration(from: Version, to: Version, up: Transform, down: Transform) → Migration</signature>
      <formal-definition format="latex">```
   create_migration(from: Version, to: Version, up: Transform, down: Transform) → Migration
   = Migration(up, down)</formal-definition>
    </operation>
    <operation>
      <name>Additive (Safe)</name>
      <signature/>
      <formal-definition format="latex">```
   Add new fields with defaults
   No data loss
   Can roll back easily</formal-definition>
    </operation>
    <operation>
      <name>Transformative</name>
      <signature/>
      <formal-definition format="latex">```
   Change field types or structure
   Requires data transformation
   Test rollback carefully</formal-definition>
    </operation>
    <operation>
      <name>Destructive (Dangerous)</name>
      <signature/>
      <formal-definition format="latex">```
   Remove fields or tables
   Potential data loss
   Ensure backups</formal-definition>
    </operation>
  </operations>
  <manifestations>
    <manifestation>
      <name>Database schema migrations</name>
    </manifestation>
    <manifestation>
      <name>API version upgrades</name>
    </manifestation>
    <manifestation>
      <name>File format conversions</name>
    </manifestation>
    <manifestation>
      <name>Configuration updates</name>
    </manifestation>
  </manifestations>
</pattern>
