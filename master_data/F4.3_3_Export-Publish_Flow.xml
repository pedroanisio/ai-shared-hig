<?xml version='1.0' encoding='utf-8'?>
<ns0:pattern xmlns:ns0="http://universal-corpus.org/schema/v1" id="F4.3" version="1.1">
  <ns0:metadata>
    <ns0:name />
    <ns0:category>pattern</ns0:category>
    <ns0:status>stable</ns0:status>
    <ns0:complexity>medium</ns0:complexity>
  </ns0:metadata>
  <ns0:definition>
    <ns0:tuple-notation format="latex">$E = (source, transform, validate, publish)$</ns0:tuple-notation>
    <ns0:components>
      <ns0:component>
        <ns0:name>source</ns0:name>
        <ns0:type>InternalData</ns0:type>
        <ns0:notation>source</ns0:notation>
        <ns0:description>internal data to export</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>transform</ns0:name>
        <ns0:type>InternalData → ExternalFormat</ns0:type>
        <ns0:notation>transform</ns0:notation>
        <ns0:description>converts to external format</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>validate</ns0:name>
        <ns0:type>ExternalFormat → Valid | Invalid</ns0:type>
        <ns0:notation>validate</ns0:notation>
        <ns0:description>checks output validity</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>publish</ns0:name>
        <ns0:type>Valid → Destination</ns0:type>
        <ns0:notation>publish</ns0:notation>
        <ns0:description>delivers to target</ns0:description>
      </ns0:component>
    </ns0:components>
  </ns0:definition>
  <ns0:type-definitions>
    <ns0:type-def>
      <ns0:name>InternalData</ns0:name>
      <ns0:definition format="latex">Data in system's internal representation</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>ExternalFormat</ns0:name>
      <ns0:definition format="latex">JSON | XML | CSV | PDF | HTML | Binary</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>Destination</ns0:name>
      <ns0:definition format="latex">File | URL | API | Stream | Storage</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>PublishResult</ns0:name>
      <ns0:definition format="latex">Success(url: URL) | Failure(error: Error)</ns0:definition>
    </ns0:type-def>
  </ns0:type-definitions>
  <ns0:properties>
    <ns0:property id="P.F4.3.1">
      <ns0:name>Format Compliance</ns0:name>
      <ns0:formal-spec format="latex">∀d ∈ InternalData: validate(transform(d)) = Valid ⇒
conforms_to_spec(transform(d))</ns0:formal-spec>
    </ns0:property>
    <ns0:property id="P.F4.3.2">
      <ns0:name>Lossless Export</ns0:name>
      <ns0:formal-spec format="latex">∀d ∈ InternalData: can_round_trip(d) ⇒
import(transform(d)) = d</ns0:formal-spec>
    </ns0:property>
    <ns0:property id="P.F4.3.3">
      <ns0:name>Atomic Publish</ns0:name>
      <ns0:formal-spec format="latex">∀d ∈ Data: publish(d) succeeds completely ∨ rolls back completely</ns0:formal-spec>
    </ns0:property>
  </ns0:properties>
  <ns0:operations>
    <ns0:operation>
      <ns0:name>Export</ns0:name>
      <ns0:signature>export(data: InternalData, format: FormatType, dest: Destination) → PublishResult</ns0:signature>
      <ns0:formal-definition format="latex">```
   export(data: InternalData, format: FormatType, dest: Destination) → PublishResult
   = try:
       external := transform(data, format)
       if validate(external) ≠ Valid:
         return Failure("Validation failed")
       result := publish(external, dest)
       return result
     catch error:
       return Failure(error)</ns0:formal-definition>
    </ns0:operation>
    <ns0:operation>
      <ns0:name>Transform</ns0:name>
      <ns0:signature>transform(data: InternalData, format: FormatType) → ExternalFormat</ns0:signature>
      <ns0:formal-definition format="latex">```
   transform(data: InternalData, format: FormatType) → ExternalFormat
   = case format of
       JSON → serialize_json(data)
       XML → serialize_xml(data, schema)
       CSV → flatten_to_csv(data)
       PDF → render_pdf(data, template)
       HTML → render_html(data, template)</ns0:formal-definition>
    </ns0:operation>
    <ns0:operation>
      <ns0:name>Publish</ns0:name>
      <ns0:signature>publish(data: ExternalFormat, dest: Destination) → PublishResult</ns0:signature>
      <ns0:formal-definition format="latex">```
   publish(data: ExternalFormat, dest: Destination) → PublishResult
   = case dest of
       File(path) → 
         write_file(path, data)
         return Success(file_url(path))
       URL(endpoint) → 
         response := http_post(endpoint, data)
         return Success(response.location)
       API(service) → 
         id := service.create(data)
         return Success(service.url(id))
       Storage(bucket) → 
         key := bucket.put(data)
         return Success(bucket.url(key))</ns0:formal-definition>
    </ns0:operation>
  </ns0:operations>
  <ns0:manifestations>
    <ns0:manifestation>
      <ns0:name>Document export</ns0:name>
      <ns0:description>PDF, Word</ns0:description>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>API publishing</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Data export</ns0:name>
      <ns0:description>CSV, JSON</ns0:description>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Report generation</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Static site generation</ns0:name>
    </ns0:manifestation>
  </ns0:manifestations>
</ns0:pattern>