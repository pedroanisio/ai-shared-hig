<?xml version='1.0' encoding='utf-8'?>
<ns0:pattern xmlns:ns0="http://universal-corpus.org/schema/v1" id="F4.2" version="1.1">
  <ns0:metadata>
    <ns0:name />
    <ns0:category>pattern</ns0:category>
    <ns0:status>stable</ns0:status>
    <ns0:complexity>medium</ns0:complexity>
  </ns0:metadata>
  <ns0:definition>
    <ns0:tuple-notation format="latex">$N = (trigger, route, format, deliver)$</ns0:tuple-notation>
    <ns0:components>
      <ns0:component>
        <ns0:name>trigger</ns0:name>
        <ns0:type>Event → Notification</ns0:type>
        <ns0:notation>trigger</ns0:notation>
        <ns0:description>creates notification from event</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>route</ns0:name>
        <ns0:type>Notification → Set⟨Channel⟩</ns0:type>
        <ns0:notation>route</ns0:notation>
        <ns0:description>selects delivery channels</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>format</ns0:name>
        <ns0:type>(Notification, Channel) → Message</ns0:type>
        <ns0:notation>format</ns0:notation>
        <ns0:description>formats for channel</ns0:description>
      </ns0:component>
      <ns0:component>
        <ns0:name>deliver</ns0:name>
        <ns0:type>(Message, Channel) → Effect</ns0:type>
        <ns0:notation>deliver</ns0:notation>
        <ns0:description>sends notification</ns0:description>
      </ns0:component>
    </ns0:components>
  </ns0:definition>
  <ns0:type-definitions>
    <ns0:type-def>
      <ns0:name>Notification</ns0:name>
      <ns0:definition format="latex">(id: String, type: NotificationType,</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>Channel</ns0:name>
      <ns0:definition format="latex">Email | Push | SMS | InApp | Webhook</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>Priority</ns0:name>
      <ns0:definition format="latex">Urgent | High | Normal | Low</ns0:definition>
    </ns0:type-def>
    <ns0:type-def>
      <ns0:name>NotificationType</ns0:name>
      <ns0:definition format="latex">Alert | Info | Success | Warning | Error</ns0:definition>
    </ns0:type-def>
  </ns0:type-definitions>
  <ns0:properties>
    <ns0:property id="P.F4.2.1">
      <ns0:name>Priority-Based Delivery</ns0:name>
      <ns0:formal-spec format="latex">∀n ∈ Notifications: priority(n) = Urgent ⇒
all_channels_enabled(n) ∧ immediate_delivery(n)</ns0:formal-spec>
    </ns0:property>
    <ns0:property id="P.F4.2.2">
      <ns0:name>User Preferences</ns0:name>
      <ns0:formal-spec format="latex">∀u ∈ Users, n ∈ Notifications:
deliver(n, channel) only if user_allows(u, channel, type(n))</ns0:formal-spec>
    </ns0:property>
    <ns0:property id="P.F4.2.3">
      <ns0:name>Deduplication</ns0:name>
      <ns0:formal-spec format="latex">∀n₁, n₂: similar(n₁, n₂) ∧ recent(n₁) ⇒ suppress(n₂)</ns0:formal-spec>
    </ns0:property>
  </ns0:properties>
  <ns0:operations>
    <ns0:operation>
      <ns0:name>Notify</ns0:name>
      <ns0:signature>notify(event: Event) → Effect</ns0:signature>
      <ns0:formal-definition format="latex">```
   notify(event: Event) → Effect
   = notification := trigger(event)
     if should_suppress(notification):
       return
     channels := route(notification)
     for channel in channels:
       message := format(notification, channel)
       deliver(message, channel)
       log_delivery(notification, channel)</ns0:formal-definition>
    </ns0:operation>
    <ns0:operation>
      <ns0:name>Route</ns0:name>
      <ns0:signature>route(notification: Notification) → Set⟨Channel⟩</ns0:signature>
      <ns0:formal-definition format="latex">```
   route(notification: Notification) → Set⟨Channel⟩
   = user := notification.recipient
     preferences := user.notification_preferences
     
     channels := {}
     case notification.priority of
       Urgent → channels := all_channels(user)
       High → channels := preferred_channels(user) ∪ {InApp}
       Normal → channels := preferred_channels(user)
       Low → channels := {InApp}
     
     return channels ∩ enabled_channels(preferences, notification.type)</ns0:formal-definition>
    </ns0:operation>
    <ns0:operation>
      <ns0:name>Format</ns0:name>
      <ns0:signature>format(notification: Notification, channel: Channel) → Message</ns0:signature>
      <ns0:formal-definition format="latex">```
   format(notification: Notification, channel: Channel) → Message
   = case channel of
       Email → format_email(notification.subject, notification.body, notification.action_url)
       Push → format_push(notification.title, notification.short_text, notification.icon)
       SMS → format_sms(notification.short_text, max_length=160)
       InApp → format_in_app(notification.full_content)
       Webhook → format_json(notification)</ns0:formal-definition>
    </ns0:operation>
  </ns0:operations>
  <ns0:manifestations>
    <ns0:manifestation>
      <ns0:name>Alert systems</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Email notifications</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Push notifications</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>In-app messages</ns0:name>
    </ns0:manifestation>
    <ns0:manifestation>
      <ns0:name>Webhook deliveries</ns0:name>
    </ns0:manifestation>
  </ns0:manifestations>
</ns0:pattern>