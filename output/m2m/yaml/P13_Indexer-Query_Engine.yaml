id: P13
version: '1.1'
schema_version: '1.0'
metadata:
  name: Indexer/Query Engine
  category: pattern
  status: stable
  complexity: medium
  domains: []
definition:
  tuple_notation: $I = (data, index, query\_processor, update)$
  description: ''
  components:
  - name: data
    type: Set⟨Item⟩
    notation: data
    description: data being indexed
  - name: index
    type: Index
    notation: index
    description: index structure (inverted index, B-tree, etc.)
  - name: query\_processor
    type: Query → Sequence⟨Item⟩
    notation: query\_processor
    description: executes queries
  - name: update
    type: Item → Effect
    notation: update
    description: maintains index consistency
type_definitions:
- name: Index
  definition: InvertedIndex | BTree | HashMap | RTree | KDTree
  notation: Index := InvertedIndex | BTree | HashMap | RTree | KDTree
- name: Query
  definition: '(predicates: Sequence⟨Predicate⟩, order: Order, limit: ℕ)'
  notation: 'Query := (predicates: Sequence⟨Predicate⟩, order: Order, limit: ℕ)'
- name: Predicate
  definition: '(field: String, op: Operator, value: Value)'
  notation: 'Predicate := (field: String, op: Operator, value: Value)'
- name: Operator
  definition: Eq | Lt | Gt | Contains | ...
  notation: Operator := Eq | Lt | Gt | Contains | ...
properties:
- id: P.P13.1
  name: Index Consistency
  formal_spec: '∀item ∈ data: item in index

    data changes → index updated'
  description: ''
  invariants: []
- id: P.P13.2
  name: Query Performance
  formal_spec: query(index) ≪ query(data)  // Much faster than linear scan
  description: ''
  invariants: []
- id: P.P13.3
  name: Space Trade-off
  formal_spec: space(index) = O(|data|)  // Linear space overhead
  description: ''
  invariants: []
operations:
- name: Build Index
  signature: 'build_index(data: Set⟨Item⟩) → Index'
  formal_definition: "```\n   build_index(data: Set⟨Item⟩) → Index\n   = index := empty_index()\n    \
    \ for item in data:\n       for field in indexed_fields:\n         value := extract(item, field)\n\
    \         index[field][value] := index[field][value] ∪ {item}\n     return index"
  preconditions: []
  postconditions: []
  effects: []
- name: Query
  signature: 'query(q: Query) → Sequence⟨Item⟩'
  formal_definition: "```\n   query(q: Query) → Sequence⟨Item⟩\n   = candidates := index_lookup(q.predicates[0])\
    \  // Use index for first predicate\n     results := filter(candidates, q.predicates[1:])  // Filter\
    \ rest\n     results := sort(results, q.order)\n     return take(results, q.limit)"
  preconditions: []
  postconditions: []
  effects: []
- name: Update Index
  signature: 'update_item(old: Item, new: Item) → Effect'
  formal_definition: "```\n   update_item(old: Item, new: Item) → Effect\n   = for field in indexed_fields:\n\
    \       old_val := extract(old, field)\n       new_val := extract(new, field)\n       if old_val ≠\
    \ new_val:\n         index[field][old_val] := index[field][old_val] ∖ {old}\n         index[field][new_val]\
    \ := index[field][new_val] ∪ {new}"
  preconditions: []
  postconditions: []
  effects: []
- name: Inverted Index (Text)
  signature: token → {documents containing token}
  formal_definition: "```\n   token → {documents containing token}\n   Example: \"hello\" → {doc1, doc5,\
    \ doc8}"
  preconditions: []
  postconditions: []
  effects: []
- name: B-Tree (Range Queries)
  signature: Sorted key → value
  formal_definition: "```\n   Sorted key → value\n   Efficient for range queries: find(x, y)"
  preconditions: []
  postconditions: []
  effects: []
- name: Spatial Index (Geometric)
  signature: ''
  formal_definition: "```\n   R-Tree or KD-Tree\n   Efficient for spatial queries: near(point, radius)"
  preconditions: []
  postconditions: []
  effects: []
- name: Graph Index
  signature: node → {adjacent nodes}
  formal_definition: "```\n   node → {adjacent nodes}\n   Efficient for graph traversal"
  preconditions: []
  postconditions: []
  effects: []
manifestations:
- name: Full-text search
  description: documents
- name: Graph indexes
  description: knowledge graphs
- name: Symbol tables
  description: code
- name: Spatial indexes
  description: GIS
