id: P62
version: '1.1'
schema_version: '1.0'
metadata:
  name: Integration Test Pattern
  category: pattern
  status: stable
  complexity: medium
  domains: []
definition:
  tuple_notation: $I = (components, interactions, environment, verify)$
  description: ''
  components:
  - name: components
    type: Set⟨Component⟩
    notation: components
    description: integrated components
  - name: interactions
    type: Sequence⟨Interaction⟩
    notation: interactions
    description: component communications
  - name: environment
    type: Environment
    notation: environment
    description: test environment (DB, API, etc.)
  - name: verify
    type: () → \mathbb{B}
    notation: verify
    description: checks end-to-end behavior
type_definitions:
- name: Component
  definition: Service | Module | System
  notation: Component := Service | Module | System
- name: Interaction
  definition: '(from: Component, to: Component, message: Message)'
  notation: 'Interaction := (from: Component, to: Component, message: Message)'
- name: Environment
  definition: '(database: DB, services: Set⟨Service⟩, config: Config)'
  notation: 'Environment := (database: DB, services: Set⟨Service⟩, config: Config)'
properties:
- id: P.P62.1
  name: Multiple Components
  formal_spec: Tests interaction between ≥2 real components
  description: ''
  invariants: []
- id: P.P62.2
  name: External Dependencies
  formal_spec: 'May use real databases, APIs, file systems

    Or test doubles (test DB, mock APIs)'
  description: ''
  invariants: []
- id: P.P62.3
  name: Slower Than Unit Tests
  formal_spec: 'Execution time: seconds (vs milliseconds for unit tests)'
  description: ''
  invariants: []
operations:
- name: Setup Environment
  signature: setup_environment() → Environment
  formal_definition: "```\n   setup_environment() → Environment\n   = db := create_test_database()\n \
    \    services := start_test_services()\n     config := load_test_config()\n     return Environment(db,\
    \ services, config)"
  preconditions: []
  postconditions: []
  effects: []
- name: Execute Integration Test
  signature: 'execute_integration(test: IntegrationTest, env: Environment) → TestResult'
  formal_definition: "```\n   execute_integration(test: IntegrationTest, env: Environment) → TestResult\n\
    \   = setup_data(env.database)\n     result := test.run(env)\n     verify_state(env)\n     return\
    \ result"
  preconditions: []
  postconditions: []
  effects: []
- name: Teardown Environment
  signature: 'teardown(env: Environment) → Effect'
  formal_definition: "```\n   teardown(env: Environment) → Effect\n   = env.database.drop()\n     env.services.stop()\n\
    \     cleanup_test_data()\n```\nintegration_test_user_registration()\n  // Setup environment\n  =\
    \ test_db := create_test_database()\n    api_client := create_api_client()\n    email_service := create_mock_email_service()\n\
    \    \n    // Execute integration flow\n    response := api_client.post(\"/register\", {\n      username:\
    \ \"newuser\",\n      email: \"new@example.com\",\n      password: \"secure123\"\n    })\n    \n \
    \   // Verify database state\n    user := test_db.query(\"SELECT * FROM users WHERE username = ?\"\
    , [\"newuser\"])\n    assert(user ≠ null)\n    assert(user.email = \"new@example.com\")\n    \n  \
    \  // Verify email sent\n    assert(email_service.sent_count = 1)\n    assert(email_service.last_email.to\
    \ = \"new@example.com\")\n    \n    // Cleanup\n    test_db.drop()"
  preconditions: []
  postconditions: []
  effects: []
- name: Top-Down
  signature: ''
  formal_definition: "```\n   Test from UI/API downward\n   Mock lower-level dependencies\n   Gradually\
    \ replace mocks with real implementations"
  preconditions: []
  postconditions: []
  effects: []
- name: Bottom-Up
  signature: ''
  formal_definition: "```\n   Test lower-level components first\n   Combine into higher-level tests\n\
    \   Build up to full system"
  preconditions: []
  postconditions: []
  effects: []
- name: Big Bang
  signature: ''
  formal_definition: "```\n   Integrate all components at once\n   Test entire system\n   Risky but fast"
  preconditions: []
  postconditions: []
  effects: []
- name: Sandwich (Hybrid)
  signature: ''
  formal_definition: "```\n   Test top and bottom layers separately\n   Integrate middle layer\n   Combine\
    \ all"
  preconditions: []
  postconditions: []
  effects: []
- name: Stub
  signature: ''
  formal_definition: "```\n   Provides canned responses\n   No verification\n   \n   email_stub := Stub(EmailService)\n\
    \   email_stub.send() → Success  // Always succeeds"
  preconditions: []
  postconditions: []
  effects: []
- name: Mock
  signature: ''
  formal_definition: "```\n   Verifies interactions\n   Records calls\n   \n   email_mock := Mock(EmailService)\n\
    \   email_mock.send(to, subject, body)\n   verify(email_mock.send).called_with(\"test@example.com\"\
    , *, *)"
  preconditions: []
  postconditions: []
  effects: []
- name: Fake
  signature: ''
  formal_definition: "```\n   Working implementation with shortcuts\n   Example: In-memory database\n\
    \   \n   fake_db := InMemoryDatabase()  // Real behavior, no persistence"
  preconditions: []
  postconditions: []
  effects: []
- name: Spy
  signature: ''
  formal_definition: "```\n   Real object with recording\n   Tracks method calls\n   \n   email_spy :=\
    \ Spy(RealEmailService)\n   email_spy.send(...)  // Actually sends, but records call\n   verify(email_spy.send).called()\n\
    ```\n1. In-Memory Database:\n   test_db := SQLite(\":memory:\")\n   Fast but limited features\n\n\
    2. Docker Container:\n   test_db := Docker.run(\"postgres:13\")\n   Real DB, isolated, clean slate\n\
    \n3. Transaction Rollback:\n   begin_transaction()\n   run_test()\n   rollback()  // Undo all changes\n\
    \n4. Fixtures:\n   load_fixtures(\"test_data.sql\")\n   run_test()\n   truncate_tables()"
  preconditions: []
  postconditions: []
  effects: []
manifestations:
- name: API integration tests
  description: ''
- name: Database integration tests
  description: ''
- name: Service-to-service tests
  description: ''
- name: End-to-end user flows
  description: ''
